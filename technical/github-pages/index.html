

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Auto-deploying GitHub pages via GNU Make &mdash; Some Notes on Interesting Things</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2012-02-24',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="Some Notes on Interesting Things" href="../../" />
    <link rel="next" title="Using Python to interoperate with GIS systems" href="" />
    <link rel="prev" title="Contents" href="../../" />
<link rel="stylesheet" href="../../_static/custom.css" type="text/css">

  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../">
          <span>Some Notes on Interesting Things</span></a></h1>
        <h2 class="heading"><span>Auto-deploying GitHub pages via GNU Make</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="../../">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="">Using Python to interoperate with GIS systems</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="auto-deploying-github-pages-via-gnu-make">
<h1>Auto-deploying GitHub pages via GNU Make<a class="headerlink" href="#auto-deploying-github-pages-via-gnu-make" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="http://pages.github.com/">GitHub pages</a> system allows you to associate a set of static (or templated) HTML with a repository or user. It is
a very useful service but is accessed in an interesting way. If your repository contains a <tt class="docutils literal"><span class="pre">gh-pages</span></tt> branch, it will
appear at the URL <tt class="docutils literal"><span class="pre">http://user.github.com/repository</span></tt>. All of these notes are maintained in a <a class="reference external" href="http://github.com/rjw57/notes">GitHub repository</a>
written in <cite>reStructured Text</cite> format.</p>
<p>The notes themselves are a part of a relatively standard <a class="reference external" href="http://sphinx.pocoo.org/">Sphinx</a> project. The project itself was generated via the
<cite>sphinx-quickstart</cite> command. The interesting bit is in the Makefile. The Makefile itself is very similar to that
generated by <tt class="docutils literal"><span class="pre">sphinx-quickstart</span></tt>. To support deploying to the <tt class="docutils literal"><span class="pre">gh-pages</span></tt> branch, we first of all need to know which
branch we&#8217;re on and, so that we can generate a commit message, when we&#8217;re running the build.</p>
<div class="highlight-make"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">CURRENT_BRANCH</span> <span class="o">=</span> <span class="k">$(</span>shell git name-rev --name-only HEAD<span class="k">)</span>
<span class="cp">ifndef CURRENT_BRANCH</span>
<span class="nv">CURRENT_BRANCH</span> <span class="o">=</span> <span class="k">$(</span>error Could not get current branch.<span class="k">)</span>
<span class="cp">endif</span>

<span class="nv">DATE</span><span class="o">=</span><span class="k">$(</span>shell date<span class="k">)</span>
</pre></div>
</td></tr></table></div>
<p>Lines 1 to 4 use some <tt class="docutils literal"><span class="pre">git</span></tt> plumbing commands to get the current branch name. If the branch name could not be obtained
for some reason, the <tt class="docutils literal"><span class="pre">CURRENT_BRANCH</span></tt> variable is set to a magic value which will trigger an error when evaluated. We
do this so that the error will only be generated if we try to use the <tt class="docutils literal"><span class="pre">CURRENT_BRANCH</span></tt> variable.</p>
<p>Line 6 simply gets the current date for the auto-commit message.</p>
<p>The meat of the deployment is done via the <tt class="docutils literal"><span class="pre">deploy</span></tt> target:</p>
<div class="highlight-make"><div class="highlight"><pre><span class="nf">deploy</span><span class="o">:</span> <span class="m">clean dirhtml</span>
        git checkout gh-pages
        -rsync -a --delete --exclude<span class="o">=</span>.* --exclude<span class="o">=</span>.git --exclude<span class="o">=</span><span class="k">$(</span>BUILDDIR<span class="k">)</span>/* <span class="k">$(</span>BUILDDIR<span class="k">)</span>/dirhtml/ .
        -git add .
        -git add -u
        -git commit -m <span class="s1">&#39;Automatic build commit on $(DATE).&#39;</span>
        git checkout <span class="k">${</span><span class="nv">CURRENT_BRANCH</span><span class="k">}</span>
</pre></div>
</div>
<p>This target first makes sure we&#8217;ve cleaned and built the current &#8216;latest&#8217; version. The remainder is quite
straightforward: we switch to the <tt class="docutils literal"><span class="pre">gh-pages</span></tt> branch. Since checking out a new branch will keep the untracked files in
the working directory, the <tt class="docutils literal"><span class="pre">$(BUILDDIR)</span></tt> is still in place. We use <tt class="docutils literal"><span class="pre">rsync</span></tt> to update the root directory from the
build directory. Note that we explicitly exclude dot-files to make sure that <tt class="docutils literal"><span class="pre">rsync</span></tt> doesn&#8217;t delete anything of
importance.</p>
<p>The build directory itself will be ignored by <tt class="docutils literal"><span class="pre">git</span></tt> since there is a <tt class="docutils literal"><span class="pre">.gitignore</span></tt> file in the <tt class="docutils literal"><span class="pre">gh-pages</span></tt> branch
which explicitly ignores it. We then use the <tt class="docutils literal"><span class="pre">git</span> <span class="pre">add</span></tt> and <tt class="docutils literal"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">-u</span></tt> commands to add any new or modified files
and to remove any deleted files. Finally we generate an automated commit and return to the original branch.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We prepend a dash (<tt class="docutils literal"><span class="pre">-</span></tt>) to all commands between the checkout of <tt class="docutils literal"><span class="pre">gh-pages</span></tt> and <tt class="docutils literal"><span class="pre">$(CURRENT_BRANCH)</span></tt> so
that if the commands fail for some reason, we don&#8217;t end with the wrong branch checked out. The dash causes Make to
ignore failures in a particular command and to keep going.</p>
</div>
<p>Initially this target also explicitly stashed and un-stashed any uncommitted changes but I removed that after deciding
that deployment is something that <cite>should</cite> only be done to a tree with no uncommitted changes.</p>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="../../">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="">Using Python to interoperate with GIS systems</a>&#160;&#160;»
        </p>

      </div>

<div class="footer">
<p>
Copyright &copy; 2012, Rich Wareham.
This <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" rel="dct:type">work</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.0/uk/">Creative Commons Attribution-NonCommercial-ShareAlike 2.0 UK: England &amp; Wales License</a>.
</p>
<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.0/uk/"><img alt="Creative Commons Licence" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/2.0/uk/80x15.png" /></a></p>
</div>

  </body>
</html>